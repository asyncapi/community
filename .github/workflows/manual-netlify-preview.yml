name: Docs Preview (Netlify)

on:
  pull_request:
    paths:
      - 'docs/**'

jobs:
  preview:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout community PR
        uses: actions/checkout@v5

      - name: Checkout website repo
        uses: actions/checkout@v5
        with:
          repository: asyncapi/website
          path: website
          fetch-depth: 1

      - name: Sync docs into website
        run: |
          rm -rf website/markdown/docs/community/*
          cp -R docs/* website/markdown/docs/community/
          rm website/markdown/docs/community/README.md

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Install jq
        run: |
          sudo apt-get update && sudo apt-get install -y jq

      - name: Install deps and build website
        working-directory: website
        run: |
          npm ci
          npm i netlify-cli@23.9.5
          npm run build

      - name: Deploy draft preview to Netlify
        id: deploy
        working-directory: website
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        run: |
          set -e
          BUILD_DIR="out"
          if [[ ! -d "$BUILD_DIR" ]]; then
            echo "Build output directory $BUILD_DIR not found"
            exit 1
          fi
          # Deploy the output that `npm run build` produced
          DEPLOY_JSON=$(netlify deploy --dir="$BUILD_DIR" --message="community PR #${{ github.event.number }}" --draft --json)
          echo "$DEPLOY_JSON"
          echo "url=$(echo "$DEPLOY_JSON" | jq -r '.deploy_url')" >> $GITHUB_OUTPUT

      - name: Comment preview URL on PR
        if: success()
        uses: thollander/actions-comment-pull-request@24bffb9b452ba05a4f3f77933840a6a841d1b32b #v3.0.1 release https://github.com/thollander/actions-comment-pull-request/releases/tag/v3.0.1
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          message: |
            ðŸš€ **Docs preview deployed**
            â†’ ${{ steps.deploy.outputs.url }}
